// Enhanced Admin Panel for RSA Assessment Management
// Location: client/src/components/admin/EnhancedAdminPanel.tsx

import React, { useState, useEffect } from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Badge } from '@/components/ui/badge';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { 
  Database, 
  Settings, 
  ClipboardList, 
  Workflow,
  Plus,
  Edit3,
  Trash2,
  Download,
  Upload,
  Eye,
  Save,
  RefreshCw,
  CheckCircle,
  AlertTriangle,
  Info
} from 'lucide-react';
import { ReusableButton } from '@/components/lego-blocks/ReusableButton';
import { ReusableModal } from '@/components/lego-blocks/ReusableModal';

interface QuestionnaireStructure {
  id: string;
  title: string;
  description: string;
  version: string;
  status: 'draft' | 'active' | 'archived';
  sections: Section[];
  totalQuestions: number;
  estimatedTime: number;
}

interface Section {
  id: string;
  title: string;
  sectionOrder: number;
  estimatedTime: number;
  questions: Question[];
  description?: string;
}

interface Question {
  id: string;
  questionText: string;
  questionType: 'text' | 'scale' | 'select' | 'multiselect' | 'ranking' | 'allocation' | 'matrix' | 'compound' | 'boolean';
  questionOrder: number;
  isRequired: boolean;
  helpText?: string;
  options?: QuestionOption[];
  metadata?: any;
}

interface QuestionOption {
  id: string;
  optionText: string;
  optionValue: string;
  scoreValue: number;
  optionOrder: number;
}

interface AssessmentStats {
  totalResponses: number;
  completionRate: number;
  averageScore: number;
  sectionPerformance: { [key: string]: number };
}

export const EnhancedAdminPanel: React.FC = () => {
  const [questionnaire, setQuestionnaire] = useState<QuestionnaireStructure | null>(null);
  const [assessmentStats, setAssessmentStats] = useState<AssessmentStats | null>(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [selectedSection, setSelectedSection] = useState<Section | null>(null);
  const [selectedQuestion, setSelectedQuestion] = useState<Question | null>(null);
  const [showQuestionModal, setShowQuestionModal] = useState(false);
  const [showSectionModal, setShowSectionModal] = useState(false);

  // Load questionnaire data
  const loadQuestionnaire = async () => {
    setLoading(true);
    try {
      const response = await fetch('/api/questionnaires/rsa-assessment');
      if (!response.ok) throw new Error('Failed to load questionnaire');
      const data = await response.json();
      setQuestionnaire(data);
      
      // Calculate totals
      const totalQuestions = data.sections.reduce((sum: number, section: Section) => sum + section.questions.length, 0);
      const estimatedTime = data.sections.reduce((sum: number, section: Section) => sum + section.estimatedTime, 0);
      
      setQuestionnaire(prev => prev ? { ...prev, totalQuestions, estimatedTime } : null);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to load questionnaire');
    } finally {
      setLoading(false);
    }
  };

  // Load assessment statistics
  const loadAssessmentStats = async () => {
    try {
      const response = await fetch('/api/assessment-stats');
      if (response.ok) {
        const stats = await response.json();
        setAssessmentStats(stats);
      }
    } catch (err) {
      console.error('Failed to load assessment stats:', err);
    }
  };

  useEffect(() => {
    loadQuestionnaire();
    loadAssessmentStats();
  }, []);

  // Seed the complete RSA assessment
  const seedAssessment = async () => {
    setLoading(true);
    try {
      const response = await fetch('/api/seed-rsa-assessment', { method: 'POST' });
      if (!response.ok) throw new Error('Failed to seed assessment');
      
      await loadQuestionnaire();
      setError(null);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to seed assessment');
    } finally {
      setLoading(false);
    }
  };

  // Export questionnaire structure
  const exportQuestionnaire = async () => {
    if (!questionnaire) return;
    
    const dataStr = JSON.stringify(questionnaire, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = `rsa-assessment-v${questionnaire.version}.json`;
    link.click();
    
    URL.revokeObjectURL(url);
  };

  // Question Type Editor Component
  const QuestionTypeEditor: React.FC<{ question: Question; onChange: (question: Question) => void }> = ({ question, onChange }) => {
    const questionTypes = [
      { value: 'text', label: 'Text Input', icon: 'üìù' },
      { value: 'scale', label: 'Rating Scale', icon: '‚≠ê' },
      { value: 'select', label: 'Single Choice', icon: 'üîò' },
      { value: 'multiselect', label: 'Multiple Choice', icon: '‚òëÔ∏è' },
      { value: 'ranking', label: 'Ranking', icon: 'üìä' },
      { value: 'allocation', label: 'Point Allocation', icon: 'üéØ' },
      { value: 'matrix', label: 'Matrix/Grid', icon: 'üìã' },
      { value: 'compound', label: 'Compound/Sub-questions', icon: 'üîó' },
      { value: 'boolean', label: 'Yes/No', icon: '‚úÖ' }
    ];

    return (
      <div className="space-y-4">
        <div>
          <label className="block text-sm font-medium mb-2">Question Type</label>
          <select 
            value={question.questionType}
            onChange={(e) => onChange({ ...question, questionType: e.target.value as Question['questionType'] })}
            className="w-full p-2 border rounded-md"
          >
            {questionTypes.map(type => (
              <option key={type.value} value={type.value}>
                {type.icon} {type.label}
              </option>
            ))}
          </select>
        </div>

        <div>
          <label className="block text-sm font-medium mb-2">Question Text</label>
          <textarea
            value={question.questionText}
            onChange={(e) => onChange({ ...question, questionText: e.target.value })}
            className="w-full p-2 border rounded-md h-24"
            placeholder="Enter your question text..."
          />
        </div>

        <div>
          <label className="block text-sm font-medium mb-2">Help Text (Optional)</label>
          <textarea
            value={question.helpText || ''}
            onChange={(e) => onChange({ ...question, helpText: e.target.value })}
            className="w-full p-2 border rounded-md h-16"
            placeholder="Provide additional context or guidance..."
          />
        </div>

        <div className="flex items-center space-x-4">
          <label className="flex items-center">
            <input
              type="checkbox"
              checked={question.isRequired}
              onChange={(e) => onChange({ ...question, isRequired: e.target.checked })}
              className="mr-2"
            />
            Required Question
          </label>
        </div>

        {/* Options editor for select/multiselect/scale questions */}
        {['select', 'multiselect', 'scale', 'ranking', 'allocation'].includes(question.questionType) && (
          <div>
            <label className="block text-sm font-medium mb-2">Answer Options</label>
            <div className="space-y-2">
              {question.options?.map((option, index) => (
                <div key={option.id} className="flex items-center space-x-2 p-2 border rounded">
                  <input
                    type="text"
                    value={option.optionText}
                    onChange={(e) => {
                      const newOptions = [...(question.options || [])];
                      newOptions[index] = { ...option, optionText: e.target.value };
                      onChange({ ...question, options: newOptions });
                    }}
                    className="flex-1 p-1 border rounded"
                    placeholder="Option text"
                  />
                  <input
                    type="number"
                    value={option.scoreValue}
                    onChange={(e) => {
                      const newOptions = [...(question.options || [])];
                      newOptions[index] = { ...option, scoreValue: parseInt(e.target.value) || 0 };
                      onChange({ ...question, options: newOptions });
                    }}
                    className="w-16 p-1 border rounded"
                    placeholder="Score"
                  />
                  <Button
                    size="sm"
                    variant="outline"
                    onClick={() => {
                      const newOptions = question.options?.filter((_, i) => i !== index) || [];
                      onChange({ ...question, options: newOptions });
                    }}
                  >
                    <Trash2 className="w-4 h-4" />
                  </Button>
                </div>
              ))}
              <Button
                size="sm"
                variant="outline"
                onClick={() => {
                  const newOption: QuestionOption = {
                    id: `option-${Date.now()}`,
                    optionText: '',
                    optionValue: '',
                    scoreValue: 1,
                    optionOrder: (question.options?.length || 0) + 1
                  };
                  onChange({ 
                    ...question, 
                    options: [...(question.options || []), newOption] 
                  });
                }}
              >
                <Plus className="w-4 h-4 mr-2" />
                Add Option
              </Button>
            </div>
          </div>
        )}
      </div>
    );
  };

  return (
    <div className="space-y-6">
      {/* Header with Quick Actions */}
      <div className="flex justify-between items-center">
        <div>
          <h2 className="text-2xl font-bold text-gray-900">Assessment Management</h2>
          <p className="text-gray-600">Manage RSA AI Maturity Assessment structure and content</p>
        </div>
        <div className="flex space-x-2">
          <ReusableButton
            onClick={loadQuestionnaire}
            variant="outline"
            size="sm"
            icon={RefreshCw}
            loading={loading}
          >
            Refresh
          </ReusableButton>
          <ReusableButton
            onClick={exportQuestionnaire}
            variant="outline"
            size="sm"
            icon={Download}
            disabled={!questionnaire}
          >
            Export
          </ReusableButton>
        </div>
      </div>

      {/* Error Alert */}
      {error && (
        <Alert variant="destructive">
          <AlertTriangle className="h-4 w-4" />
          <AlertDescription>{error}</AlertDescription>
        </Alert>
      )}

      {/* Quick Stats */}
      {questionnaire && (
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
          <Card>
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-gray-600">Total Questions</p>
                  <p className="text-2xl font-bold">{questionnaire.totalQuestions}</p>
                </div>
                <ClipboardList className="w-8 h-8 text-blue-500" />
              </div>
            </CardContent>
          </Card>
          
          <Card>
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-gray-600">Sections</p>
                  <p className="text-2xl font-bold">{questionnaire.sections.length}</p>
                </div>
                <Workflow className="w-8 h-8 text-green-500" />
              </div>
            </CardContent>
          </Card>
          
          <Card>
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-gray-600">Est. Time</p>
                  <p className="text-2xl font-bold">{questionnaire.estimatedTime}m</p>
                </div>
                <Info className="w-8 h-8 text-orange-500" />
              </div>
            </CardContent>
          </Card>
          
          <Card>
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-gray-600">Status</p>
                  <Badge variant={questionnaire.status === 'active' ? 'default' : 'secondary'}>
                    {questionnaire.status}
                  </Badge>
                </div>
                <CheckCircle className="w-8 h-8 text-purple-500" />
              </div>
            </CardContent>
          </Card>
        </div>
      )}

      <Tabs defaultValue="overview" className="space-y-4">
        <TabsList className="grid w-full grid-cols-4">
          <TabsTrigger value="overview">
            <Database className="w-4 h-4 mr-2" />
            Overview
          </TabsTrigger>
          <TabsTrigger value="sections">
            <Workflow className="w-4 h-4 mr-2" />
            Sections
          </TabsTrigger>
          <TabsTrigger value="questions">
            <ClipboardList className="w-4 h-4 mr-2" />
            Questions
          </TabsTrigger>
          <TabsTrigger value="settings">
            <Settings className="w-4 h-4 mr-2" />
            Settings
          </TabsTrigger>
        </TabsList>

        {/* Overview Tab */}
        <TabsContent value="overview" className="space-y-4">
          {!questionnaire || questionnaire.totalQuestions < 20 ? (
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center">
                  <AlertTriangle className="w-5 h-5 mr-2 text-orange-500" />
                  Assessment Setup Required
                </CardTitle>
                <CardDescription>
                  The RSA AI Maturity Assessment needs to be populated with the full question set.
                </CardDescription>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  <Alert>
                    <Info className="h-4 w-4" />
                    <AlertDescription>
                      This will create the complete 6-section assessment with 100+ questions covering:
                      Business Strategy, Data Capabilities, Use Cases, Technology, People & Change, and Compliance.
                    </AlertDescription>
                  </Alert>
                  
                  <ReusableButton
                    onClick={seedAssessment}
                    loading={loading}
                    className="w-full"
                    icon={Database}
                  >
                    {loading ? 'Creating Assessment...' : 'Create Complete RSA Assessment'}
                  </ReusableButton>
                </div>
              </CardContent>
            </Card>
          ) : (
            <Card>
              <CardHeader>
                <CardTitle className="text-green-600 flex items-center">
                  <CheckCircle className="w-5 h-5 mr-2" />
                  Assessment Ready
                </CardTitle>
                <CardDescription>
                  The RSA AI Maturity Assessment is fully configured and ready for use.
                </CardDescription>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  <div className="grid grid-cols-2 gap-4 text-sm">
                    <div>
                      <span className="font-medium">Version:</span> {questionnaire.version}
                    </div>
                    <div>
                      <span className="font-medium">Last Updated:</span> Recently
                    </div>
                    <div>
                      <span className="font-medium">Total Questions:</span> {questionnaire.totalQuestions}
                    </div>
                    <div>
                      <span className="font-medium">Estimated Time:</span> {questionnaire.estimatedTime} minutes
                    </div>
                  </div>
                  
                  {assessmentStats && (
                    <div className="border-t pt-4">
                      <h4 className="font-medium mb-2">Usage Statistics</h4>
                      <div className="grid grid-cols-3 gap-4 text-sm">
                        <div>
                          <span className="font-medium">Responses:</span> {assessmentStats.totalResponses}
                        </div>
                        <div>
                          <span className="font-medium">Completion Rate:</span> {assessmentStats.completionRate}%
                        </div>
                        <div>
                          <span className="font-medium">Avg Score:</span> {assessmentStats.averageScore}
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              </CardContent>
            </Card>
          )}
        </TabsContent>

        {/* Sections Tab */}
        <TabsContent value="sections" className="space-y-4">
          {questionnaire ? (
            <div className="space-y-4">
              {questionnaire.sections.map((section, index) => (
                <Card key={section.id}>
                  <CardHeader>
                    <div className="flex justify-between items-start">
                      <div>
                        <CardTitle className="text-lg">
                          {index + 1}. {section.title}
                        </CardTitle>
                        <CardDescription>
                          {section.questions.length} questions ‚Ä¢ {section.estimatedTime} minutes
                        </CardDescription>
                      </div>
                      <div className="flex space-x-2">
                        <Button
                          size="sm"
                          variant="outline"
                          onClick={() => {
                            setSelectedSection(section);
                            setShowSectionModal(true);
                          }}
                        >
                          <Edit3 className="w-4 h-4" />
                        </Button>
                        <Button
                          size="sm"
                          variant="outline"
                          onClick={() => {
                            // View section details
                          }}
                        >
                          <Eye className="w-4 h-4" />
                        </Button>
                      </div>
                    </div>
                  </CardHeader>
                  <CardContent>
                    <div className="space-y-2">
                      {section.description && (
                        <p className="text-sm text-gray-600">{section.description}</p>
                      )}
                      <div className="flex flex-wrap gap-2">
                        {section.questions.slice(0, 5).map((q, qIndex) => (
                          <Badge key={q.id} variant="secondary" className="text-xs">
                            Q{qIndex + 1}: {q.questionType}
                          </Badge>
                        ))}
                        {section.questions.length > 5 && (
                          <Badge variant="outline" className="text-xs">
                            +{section.questions.length - 5} more
                          </Badge>
                        )}
                      </div>
                    </div>
                  </CardContent>
                </Card>
              ))}
            </div>
          ) : (
            <div className="text-center text-gray-500 py-8">
              No questionnaire loaded. Please create or load an assessment first.
            </div>
          )}
        </TabsContent>

        {/* Questions Tab */}
        <TabsContent value="questions" className="space-y-4">
          {questionnaire ? (
            <div className="space-y-6">
              {questionnaire.sections.map((section, sectionIndex) => (
                <Card key={section.id}>
                  <CardHeader>
                    <CardTitle className="flex items-center justify-between">
                      <span>Section {sectionIndex + 1}: {section.title}</span>
                      <Badge>{section.questions.length} questions</Badge>
                    </CardTitle>
                  </CardHeader>
                  <CardContent>
                    <div className="space-y-3">
                      {section.questions.map((question, questionIndex) => (
                        <div key={question.id} className="flex items-start justify-between p-3 border rounded-lg">
                          <div className="flex-1">
                            <div className="flex items-center space-x-2 mb-1">
                              <Badge variant="outline" className="text-xs">
                                Q{questionIndex + 1}
                              </Badge>
                              <Badge variant="secondary" className="text-xs">
                                {question.questionType}
                              </Badge>
                              {question.isRequired && (
                                <Badge variant="destructive" className="text-xs">
                                  Required
                                </Badge>
                              )}
                            </div>
                            <p className="text-sm text-gray-900 mb-1">
                              {question.questionText}
                            </p>
                            {question.helpText && (
                              <p className="text-xs text-gray-500">{question.helpText}</p>
                            )}
                            {question.options && question.options.length > 0 && (
                              <div className="mt-2">
                                <span className="text-xs text-gray-500">
                                  {question.options.length} options
                                </span>
                              </div>
                            )}
                          </div>
                          <div className="flex space-x-1">
                            <Button
                              size="sm"
                              variant="outline"
                              onClick={() => {
                                setSelectedQuestion(question);
                                setShowQuestionModal(true);
                              }}
                            >
                              <Edit3 className="w-3 h-3" />
                            </Button>
                          </div>
                        </div>
                      ))}
                    </div>
                  </CardContent>
                </Card>
              ))}
            </div>
          ) : (
            <div className="text-center text-gray-500 py-8">
              No questionnaire loaded. Please create or load an assessment first.
            </div>
          )}
        </TabsContent>

        {/* Settings Tab */}
        <TabsContent value="settings" className="space-y-4">
          <Card>
            <CardHeader>
              <CardTitle>Assessment Configuration</CardTitle>
              <CardDescription>
                Global settings for the RSA AI Maturity Assessment
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium mb-2">Assessment Title</label>
                  <input
                    type="text"
                    value={questionnaire?.title || ''}
                    className="w-full p-2 border rounded-md"
                    placeholder="Assessment title"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-2">Version</label>
                  <input
                    type="text"
                    value={questionnaire?.version || ''}
                    className="w-full p-2 border rounded-md"
                    placeholder="Version number"
                  />
                </div>
              </div>
              
              <div>
                <label className="block text-sm font-medium mb-2">Description</label>
                <textarea
                  value={questionnaire?.description || ''}
                  className="w-full p-2 border rounded-md h-24"
                  placeholder="Assessment description"
                />
              </div>

              <div className="flex space-x-2">
                <ReusableButton icon={Save}>
                  Save Changes
                </ReusableButton>
                <ReusableButton variant="outline" icon={RefreshCw}>
                  Reset to Default
                </ReusableButton>
              </div>
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>

      {/* Question Edit Modal */}
      <ReusableModal
        isOpen={showQuestionModal}
        onClose={() => setShowQuestionModal(false)}
        title="Edit Question"
        size="lg"
      >
        {selectedQuestion && (
          <div className="space-y-4">
            <QuestionTypeEditor
              question={selectedQuestion}
              onChange={setSelectedQuestion}
            />
            <div className="flex justify-end space-x-2">
              <Button variant="outline" onClick={() => setShowQuestionModal(false)}>
                Cancel
              </Button>
              <Button onClick={() => {
                // Save question changes
                setShowQuestionModal(false);
              }}>
                Save Changes
              </Button>
            </div>
          </div>
        )}
      </ReusableModal>

      {/* Section Edit Modal */}
      <ReusableModal
        isOpen={showSectionModal}
        onClose={() => setShowSectionModal(false)}
        title="Edit Section"
        size="md"
      >
        {selectedSection && (
          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium mb-2">Section Title</label>
              <input
                type="text"
                value={selectedSection.title}
                onChange={(e) => setSelectedSection({ ...selectedSection, title: e.target.value })}
                className="w-full p-2 border rounded-md"
              />
            </div>
            <div>
              <label className="block text-sm font-medium mb-2">Estimated Time (minutes)</label>
              <input
                type="number"
                value={selectedSection.estimatedTime}
                onChange={(e) => setSelectedSection({ 
                  ...selectedSection, 
                  estimatedTime: parseInt(e.target.value) || 0 
                })}
                className="w-full p-2 border rounded-md"
              />
            </div>
            <div className="flex justify-end space-x-2">
              <Button variant="outline" onClick={() => setShowSectionModal(false)}>
                Cancel
              </Button>
              <Button onClick={() => {
                // Save section changes
                setShowSectionModal(false);
              }}>
                Save Changes
              </Button>
            </div>
          </div>
        )}
      </ReusableModal>
    </div>
  );
};