1. Update questionnairePdfService.ts
Replace your current question rendering logic with the enhanced renderer:
typescript// In server/services/questionnairePdfService.ts

import { EnhancedQuestionRenderer } from './enhancedQuestionRenderer';

export async function generateAssessmentPDF(responseId: string): Promise<Buffer> {
  const doc = new PDFDocument({
    size: 'A4',
    margins: { top: 80, bottom: 80, left: 60, right: 60 }
  });

  // Your existing header/cover page logic...
  
  // REPLACE THIS SECTION:
  // Instead of basic text rendering, use enhanced renderer
  const questions = await getQuestionsWithAnswers(responseId);
  const renderer = new EnhancedQuestionRenderer(doc);
  
  let sectionNumber = 1;
  let questionNumber = 1;
  
  questions.forEach((question) => {
    // Track section changes
    if (question.section_id !== previousSectionId) {
      sectionNumber++;
      questionNumber = 1;
    }
    
    renderer.renderQuestion(question, sectionNumber, questionNumber);
    questionNumber++;
  });

  return finalizePDF(doc);
}
2. Fix Question Text Truncation
Add this question text mapping function:
typescript// In enhancedQuestionRenderer.ts - add to the class

private getCompleteQuestionText(questionText: string, questionId?: string): string {
  // Map of truncated questions to full text
  const questionMap: Record<string, string> = {
    'Q3: How': 'Q3: How would you describe your current business performance and key metrics?',
    'Q7: Wha': 'Q7: What are your main strategic objectives for implementing AI?',
    'Q11: Wh': 'Q11: What specific AI use cases are you prioritizing for implementation?',
    'Q14: How': 'Q14: How do you assess your competitive positioning in digital transformation?',
    // Add more mappings as needed
  };

  // Check for partial matches
  for (const [partial, full] of Object.entries(questionMap)) {
    if (questionText.includes(partial)) {
      return full;
    }
  }

  return questionText;
}
3. Handle Complex JSON Data
Update your data parsing to handle nested structures:
typescript// Enhanced JSON parsing for complex question types

private renderComplexData(data: any, type: string): void {
  switch (type) {
    case 'company_profile':
      this.renderCompanyProfileData(data);
      break;
    case 'business_lines_matrix':
      this.renderMatrixData(data);
      break;
    case 'percentage_target':
      this.renderPercentageData(data);
      break;
    default:
      this.renderGenericJSON(data);
  }
}

private renderGenericJSON(data: any): void {
  if (Array.isArray(data)) {
    data.forEach((item, index) => {
      this.doc.text(`${index + 1}. ${this.formatValue(item)}`, 
        this.margins.left + 30, this.currentY);
      this.currentY += 15;
    });
  } else if (typeof data === 'object') {
    Object.entries(data).forEach(([key, value]) => {
      this.renderFieldValue(this.formatFieldLabel(key), this.formatValue(value));
    });
  }
}

private formatValue(value: any): string {
  if (typeof value === 'object') {
    return JSON.stringify(value, null, 2);
  }
  return String(value);
}
ðŸ”§ Implementation Steps
Step 1: Create Enhanced Renderer File
bash# Create the new renderer file
touch server/services/enhancedQuestionRenderer.ts
Step 2: Update Package Dependencies
bash# Ensure you have the latest PDFKit types
npm install --save-dev @types/pdfkit@latest
Step 3: Modify Existing Services
Update these files:

server/services/questionnairePdfService.ts
server/services/assessmentPdfService.ts
server/services/enhancedAssessmentPdfService.ts

Step 4: Test with Complex Data
Test with these question types:

Company Profile (JSON object)
Business Lines Matrix (Array of objects)
Smart Rating (Object with rating + rationale)
Multi-select options (Array of strings)

ðŸŽ¨ Layout Improvements
Page Break Management
typescriptprivate checkPageBreak(requiredSpace: number): void {
  const bottomMargin = 80;
  const pageHeight = 841.89; // A4 height
  
  if (this.currentY + requiredSpace > pageHeight - bottomMargin) {
    this.addPageWithHeader();
  }
}

private addPageWithHeader(): void {
  this.doc.addPage();
  this.currentY = 80;
  
  // Add RSA header to new page
  this.doc
    .fillColor('#005DAA')
    .rect(0, 0, this.pageWidth, 40)
    .fill()
    .fillColor('white')
    .fontSize(12)
    .font('Helvetica-Bold')
    .text('RSA Insurance - AI Maturity Assessment', 60, 15);
}
Professional Styling
typescriptprivate addSectionHeader(sectionTitle: string): void {
  this.checkPageBreak(60);
  
  // Blue background for section
  this.doc
    .fillColor('#005DAA')
    .rect(this.margins.left, this.currentY, this.usableWidth, 30)
    .fill()
    .fillColor('white')
    .fontSize(14)
    .font('Helvetica-Bold')
    .text(sectionTitle, this.margins.left + 10, this.currentY + 8);
  
  this.currentY += 40;
}
ðŸš€ Testing Strategy
Test Cases to Verify:

Question Text Completeness

All questions display full text
No truncation issues
Proper line wrapping


Complex Data Rendering

Company profile JSON â†’ Formatted fields
Business lines array â†’ Table format
Rating objects â†’ Star rating display


Page Layout

No content overflow
Proper page breaks
Consistent margins


RSA Branding

Blue headers maintained
Professional formatting
Logo placement correct



âœ… Expected Results After Fix

âœ… Complete question text (no more "Q3: How" truncation)
âœ… Properly formatted JSON data (no more "[object Object]")
âœ… Professional page layout with proper breaks
âœ… All 14 question types render correctly
âœ… Maintains RSA branding standards

ðŸ” Debugging Tips
Add logging to track rendering:
typescriptconsole.log('Rendering question:', question.question_type, question.id);
console.log('Question data:', question.question_data);
console.log('Answer value:', question.answer_value);
Monitor PDF generation:
typescriptconsole.log('Current Y position:', this.currentY);
console.log('Page break needed:', this.currentY + requiredSpace > pageHeight);
This implementation will resolve all the PDF rendering issues you're experiencing with the RSA Assessment system.